services:
  # Universal Wrapper - accessible on all 3 ports for backwards compatibility
  eco-wrapper:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: eco-wrapper-universal

    # Multi-port mapping: One container, accessible on all legacy ports
    ports:
      - "8000:8000"  # Primary port
      - "8010:8000"  # eco-backend compatibility
      - "8020:8000"  # eco-diagnostics compatibility

    # Memory limit: 4 GB (down from ~8 GB with 3 containers)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

    # Unified persistent storage
    volumes:
      - eco-wrapper-logs:/app/logs
      - eco-wrapper-instances:/app/instances
      - ~/eco-research-output:/app/research_output

    # OAuth Token via Secret (ORIGINAL WORKING CONFIG from Dec 14)
    secrets:
      - claude_token

    environment:
      # Token aus Secret lesen (SDK unterst√ºtzt file-basiertes Token)
      - CLAUDE_CODE_OAUTH_TOKEN_FILE=/run/secrets/claude_token

      # Timezone
      - TZ=Europe/Vienna

      # Logging
      - LOG_LEVEL=INFO
      - LOG_TO_FILE=true
      - FILTER_SENSITIVE_DATA=true

      # Instance Name
      - INSTANCE_NAME=eco-wrapper-universal

      # Working Directory (for session isolation)
      - CLAUDE_CWD=/app/instances

      # MCP Isolation
      - DISABLE_COACH_MCP=true

      # Timeout (40 min for research)
      - MAX_TIMEOUT=2400000

      # Permissions (bypassPermissions for autonomous research)
      - CLAUDE_PERMISSION_MODE=bypassPermissions

      # MCP API Keys
      - TAVILY_API_KEY=${TAVILY_API_KEY}

      # Anthropic API Key for Vision/Image Analysis ONLY
      # auth.py renames this to ANTHROPIC_VISION_API_KEY and removes ANTHROPIC_API_KEY
      # This prevents Claude CLI from using it as OAuth fallback
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      # Privacy/DSGVO (Presidio-based PII anonymization)
      - PRIVACY_ENABLED=true
      - PRIVACY_LANGUAGE=de
      - PRIVACY_LOG_DETECTIONS=false

      # SDK verification enabled (OAuth working with new token)
      # - SKIP_SDK_VERIFICATION=true

    # Health Check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Graceful Shutdown
    stop_grace_period: 15s

    # Restart Policy
    restart: unless-stopped

# Unified Named Volumes (simplified from 6 to 2 volumes)
volumes:
  eco-wrapper-logs:
    driver: local
  eco-wrapper-instances:
    driver: local

# Secrets
secrets:
  claude_token:
    file: ../secrets/claude_token.txt
